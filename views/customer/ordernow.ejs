<%- include('../partials/customerHeader', { customerName: customerName }) %>

<body>
  <h1>Order Review for <%= meal.name %></h1>

  <div class="meal-card">
    <div class="meal-content">
      <h2 class="meal-name"><%= meal.name %></h2>
      <p><strong>Price:</strong> ₹<span id="meal-price"><%= meal.price %></span></p>
      <p><strong>Contents:</strong> <%= meal.contents %></p>
      <p><strong>Delivery Time:</strong> <%= meal.delivery_time %></p>
      <p><strong>Seller:</strong> <%= meal.seller_name %></p>
    </div>

    <div class="img-box">
      <% if (meal.image_url) { %>
        <img class="meal-img" src="<%= meal.image_url %>" alt="<%= meal.name %>">
      <% } %>
    </div>
  </div>

  <div class="location-info">
    <p><strong>Choose Delivery Location:</strong></p>
    
    <label>
      <input type="checkbox" id="use-current-location" onchange="toggleAddressInput()">
      Use my current location: <%= customerLocation %>
    </label>
    
    <div id="new-address-container">
      <p>Or enter a new delivery address:</p>
      <input type="text" id="delivery-address" placeholder="Enter your delivery address">
    </div>
    <p id="location-error" style="color: red; display: none;">Please select or enter a delivery location.</p>
  </div>

  <button id="pay-button" style="position: static; margin-top:20px; margin-bottom:20px; margin-left: 47%;" disabled>Pay</button>

  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  <script>
    document.getElementById('pay-button').onclick = function (e) {
      e.preventDefault(); 
      
      const useCurrentLocation = document.getElementById('use-current-location').checked;
      const newAddress = document.getElementById('delivery-address').value.trim();
      
      if (!useCurrentLocation && !newAddress) {
        document.getElementById('location-error').style.display = 'block';
        return;
      }

      const price = document.getElementById('meal-price').innerText.replace('₹', '').trim();
      const amountInPaise = parseFloat(price) * 100;
      const deliveryAddress = useCurrentLocation ? "<%= customerLocation %>" : newAddress;

      fetch('/create-order', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          amount: amountInPaise,
          address: deliveryAddress  // Include the address in the order request
        })
      })
      .then(response => response.json())
      .then(data => {
        var options = {
          "key": "<%= process.env.RAZORPAY_KEY_ID %>", 
          "amount": data.amount, 
          "currency": "INR",
          "name": "Your Company",
          "description": "Meal Order",
          "order_id": data.id, 
          "handler": function (response) {
            fetch('/payment-confirmation', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                paymentId: response.razorpay_payment_id,
                orderId: response.razorpay_order_id
              })
            })
            .then(() => window.location.href = '/payment-confirmation');
          },
          "prefill": {
            "name": "<%= customerName %>",
            "email": "customer@example.com",
            "contact": "9999999999"
          }
        };
        var rzp1 = new Razorpay(options);
        rzp1.open();
      })
      .catch(error => console.error('Error:', error));
    }

    function toggleAddressInput() {
      const useCurrentLocation = document.getElementById('use-current-location');
      const newAddressContainer = document.getElementById('new-address-container');
      const payButton = document.getElementById('pay-button');
      
      if (useCurrentLocation.checked) {
        newAddressContainer.style.display = 'none';
        payButton.disabled = false;
        document.getElementById('location-error').style.display = 'none';
      } else {
        newAddressContainer.style.display = 'block';
        validateLocation();
      }
    }

    function validateLocation() {
      const newAddress = document.getElementById('delivery-address').value.trim();
      const payButton = document.getElementById('pay-button');
      const locationError = document.getElementById('location-error');

      if (newAddress) {
        payButton.disabled = false;
        locationError.style.display = 'none';
      } else {
        payButton.disabled = true;
      }
    }

    document.getElementById('delivery-address').addEventListener('input', validateLocation);

    // Initialize validation on page load
    toggleAddressInput();
  </script>
</body>

<%- include('../partials/footer') %>
