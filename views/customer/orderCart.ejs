<%- include('../partials/customerHeader', { customerName: customerName }) %>

<body>
  <h1>Confirm Your Order</h1>

  <div class="meal-container">
    <% if (cartItems.length > 0) { %>
      <% cartItems.forEach(item => { %>
        <div class="meal-card" data-seller-id="<%= item.seller_id %>">
          <div class="meal-content">
            <h2 class="meal-name"><%= item.name %></h2>
            <p><strong>Price:</strong> ₹<span class="meal-price"><%= item.price %></span></p>
            <p><strong>Contents:</strong> <%= item.contents %></p>
            <p><strong>Preparation Time:</strong> <%= item.prep_time %></p>
            <p><strong>Seller:</strong> <%= item.seller_name %></p>
          </div>
          <div class="img-box">
            <% if (item.image_url) { %>
              <img class="meal-img" src="<%= item.image_url %>" alt="<%= item.name %>">
            <% } %>
          </div>
        </div>
      <% }) %>
    </div>  

    <div class="location-info">
      <p><strong>Choose Delivery Location:</strong></p>
      
      <label>
        <input type="checkbox" id="use-current-location" onchange="toggleAddressInput()">
        Use my current location: <%= customerLocation %>
      </label>
      
      <div id="new-address-container">
        <p>Or enter a new delivery address:</p>
        <input type="text" id="delivery-address" placeholder="Enter your delivery address">
      </div>
      <p id="location-error" style="color: red; display: none;">Please select or enter a delivery location.</p>
    </div>

    <button id="pay-button" style="position: static; margin-top:20px; margin-bottom:20px; margin-left: 47%;" disabled>Pay</button>

    <% } else { %>
      <h2>Your cart is empty.</h2>
    <% } %>

  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  <script>

document.getElementById('pay-button').onclick = async function (e) {
  e.preventDefault();

  const totalAmount = await calculateTotalAmount() * 100; // Total in paise
  const deliveryAddress = document.getElementById('use-current-location').checked ? "<%= customerLocation %>" : document.getElementById('delivery-address').value;

  if (!deliveryAddress) {
    alert('Please select or enter a delivery location.');
    return;
  }

  const mealCards = document.querySelectorAll('.meal-card');
  const meals = Array.from(mealCards).map(card => ({
    name: card.querySelector('.meal-name').innerText,
    price: parseFloat(card.querySelector('.meal-price').innerText.replace('₹', '').trim()),
    sellerId: card.getAttribute('data-seller-id')
  }));

  fetch('/create-orders', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      meals: meals,
      address: deliveryAddress
    })
  })
  .then(response => response.json())
  .then(data => {
    const options = {
      "key": "<%= process.env.RAZORPAY_KEY_ID %>",
      "amount": data.amount,
      "order_id": data.id,
      "handler": function (response) {
        fetch('/payment-confirmations', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            paymentId: response.razorpay_payment_id,
            orderId: response.razorpay_order_id
          })
        })
        .then(() => window.location.href = '/payment-confirmations');
      }
    };
    const rzp1 = new Razorpay(options);
    rzp1.open();
  })
  .catch(error => console.error('Error:', error));
};
    function calculateTotalAmount() {
      let total = 0;
      document.querySelectorAll('.meal-price').forEach(function (priceElement) {
        const price = parseFloat(priceElement.innerText.replace('₹', '').trim());
        total += price;
      });
      return total;
    }

    function toggleAddressInput() {
      const useCurrentLocation = document.getElementById('use-current-location');
      const newAddressContainer = document.getElementById('new-address-container');
      const payButton = document.getElementById('pay-button');

      if (useCurrentLocation.checked) {
        newAddressContainer.style.display = 'none';
        payButton.disabled = false;
        document.getElementById('location-error').style.display = 'none';
      } else {
        newAddressContainer.style.display = 'block';
        validateLocation();
      }
    }

    function validateLocation() {
      const newAddress = document.getElementById('delivery-address').value.trim();
      const payButton = document.getElementById('pay-button');
      const locationError = document.getElementById('location-error');

      if (newAddress) {
        payButton.disabled = false;
        locationError.style.display = 'none';
      } else {
        payButton.disabled = true;
      }
    }
    document.getElementById('delivery-address').addEventListener('input', validateLocation);
    toggleAddressInput();
  </script>
</body>

<%- include('../partials/footer') %> 